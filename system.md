# Merge, Then Compress: Demystify Efficient SMoE with Hints from Its Routing Policy

- 在國網上跑得起來


## 國網的環境
- Python 3.10.6
- `nvidia-smi`: NVIDIA-SMI 470.161.03   Driver Version: 470.161.03   CUDA Version: 12.1

pip list version
```
Package                       Version              Editable project location
----------------------------- -------------------- ----------------------------------------------------
absl-py                       1.4.0
accelerate                    0.28.0
addict                        2.4.0
aiohttp                       3.8.4
aiosignal                     1.3.1
alabaster                     0.7.13
altair                        5.3.0
anyio                         4.3.0
apex                          0.1
appdirs                       1.4.4
argon2-cffi                   21.3.0
argon2-cffi-bindings          21.2.0
astor                         0.8.1
asttokens                     2.2.1
astunparse                    1.6.3
async-timeout                 4.0.2
attrs                         23.1.0
audioread                     3.0.0
auto_gptq                     0.7.1
Babel                         2.12.1
backcall                      0.2.0
base58                        2.1.1
beautifulsoup4                4.12.2
black                         21.12b0
bleach                        6.0.0
blinker                       1.7.0
blis                          0.7.9
boto3                         1.26.164
botocore                      1.29.164
Brotli                        1.1.0
cachetools                    5.3.0
catalogue                     2.0.8
certifi                       2022.12.7
cffi                          1.15.1
chardet                       4.0.0
charset-normalizer            3.1.0
click                         7.1.2
cloudpickle                   2.2.1
cmake                         3.24.1.1
cn2an                         0.5.22
colorama                      0.4.6
colorclass                    2.2.2
coloredlogs                   15.0.1
comm                          0.1.3
confection                    0.0.4
contourpy                     1.0.7
cpm-kernels                   1.0.11
cubinlinker                   0.2.2+2.g2f92cb3
cuda-python                   12.1.0rc5+1.gcdeccdd
cudf                          23.4.0
cugraph                       23.4.0
cugraph-dgl                   23.4.0
cugraph-service-client        23.4.0
cugraph-service-server        23.4.0
cuml                          23.4.0
cupy-cuda12x                  12.0.0b3
cycler                        0.11.0
cymem                         2.0.7
Cython                        0.29.34
dask                          2023.3.2
dask-cuda                     23.4.0
dask-cudf                     23.4.0
DataProperty                  1.0.1
datasets                      2.18.0
dbus-python                   1.2.18
debugpy                       1.6.7
decorator                     5.1.1
deepspeed                     0.14.0
defusedxml                    0.7.1
diffusers                     0.27.2
dill                          0.3.8
distributed                   2023.3.2.1
distro                        1.8.0
docker-pycreds                0.4.0
docutils                      0.18
einops                        0.5.0
evaluate                      0.4.1
exceptiongroup                1.1.1
execnet                       1.9.0
executing                     1.2.0
expecttest                    0.1.3
fairscale                     0.4.13
fastjsonschema                2.16.3
fastrlock                     0.8.1
feedparser                    6.0.10
filelock                      3.12.0
fire                          0.6.0
flake8                        7.0.0
flash-attn                    1.0.5
fonttools                     4.39.3
frozenlist                    1.3.3
fsspec                        2024.2.0
func-timeout                  4.3.5
fuzzywuzzy                    0.18.0
gast                          0.4.0
gdown                         5.1.0
gekko                         1.0.7
gitdb                         4.0.11
GitPython                     3.1.43
google-auth                   2.18.1
google-auth-oauthlib          0.4.6
graphsurgeon                  0.4.6
grpcio                        1.54.2
h11                           0.14.0
hjson                         3.1.0
httpcore                      1.0.4
httpx                         0.27.0
huggingface-hub               0.21.4
humanfriendly                 10.0
hypothesis                    5.35.1
idna                          3.4
imagesize                     1.4.1
immutabledict                 4.2.0
importlib-metadata            6.6.0
inflate64                     1.0.0
iniconfig                     2.0.0
intel-openmp                  2021.4.0
ipykernel                     6.23.1
ipython                       8.13.2
ipython-genutils              0.2.0
isort                         5.8.0
jedi                          0.18.2
jieba                         0.42.1
Jinja2                        3.1.2
jmespath                      1.0.1
joblib                        1.2.0
json5                         0.9.14
jsonlines                     4.0.0
jsonschema                    4.17.3
jupyter_client                8.2.0
jupyter_core                  5.3.0
jupyter-tensorboard           0.2.0
jupyterlab                    2.3.2
jupyterlab-pygments           0.2.2
jupyterlab-server             1.2.0
jupytext                      1.14.5
kiwisolver                    1.4.4
langcodes                     3.3.0
langdetect                    1.0.9
Levenshtein                   0.25.0
librosa                       0.9.2
lit                           16.0.5
llvmlite                      0.39.1
lm_eval                       0.4.2                /home/u2139934/MoE_Experiments/lm-evaluation-harness
locket                        1.0.0
loguru                        0.7.0
ltp                           4.2.13
ltp-core                      0.1.4
ltp-extension                 0.1.11
lxml                          5.1.0
Markdown                      3.4.3
markdown-it-py                3.0.0
MarkupSafe                    2.1.2
matplotlib                    3.7.1
matplotlib-inline             0.1.6
mbstrdecoder                  1.1.3
mccabe                        0.7.0
mdit-py-plugins               0.4.0
mdurl                         0.1.2
mistune                       2.0.5
mkl                           2021.1.1
mkl-devel                     2021.1.1
mkl-include                   2021.1.1
mmengine-lite                 0.10.3
mock                          5.0.2
more-itertools                10.2.0
mpmath                        1.3.0
msgpack                       1.0.5
multidict                     6.0.4
multiprocess                  0.70.16
multivolumefile               0.2.3
murmurhash                    1.0.9
mypy-extensions               1.0.0
myst-parser                   2.0.0
nbclient                      0.7.4
nbconvert                     7.4.0
nbformat                      5.8.0
nest-asyncio                  1.5.6
netaddr                       0.8.0
networkx                      2.6.3
ninja                         1.11.1
nltk                          3.8
notebook                      6.4.10
numba                         0.56.4+1.g48c75e48f
numexpr                       2.9.0
numpy                         1.26.4
nvidia-cublas-cu12            12.1.3.1
nvidia-cuda-cupti-cu12        12.1.105
nvidia-cuda-nvrtc-cu12        12.1.105
nvidia-cuda-runtime-cu12      12.1.105
nvidia-cudnn-cu12             8.9.2.26
nvidia-cufft-cu12             11.0.2.54
nvidia-curand-cu12            10.3.2.106
nvidia-cusolver-cu12          11.4.5.107
nvidia-cusparse-cu12          12.1.0.106
nvidia-dali-cuda120           1.25.0
nvidia-nccl-cu12              2.19.3
nvidia-nvjitlink-cu12         12.4.99
nvidia-nvtx-cu12              12.1.105
nvidia-pyindex                1.0.9
nvtx                          0.2.5
oauthlib                      3.2.2
onnx                          1.13.1rc2
openai                        1.14.2
OpenCC                        1.1.7
opencompass                   0.2.3                /home/u2139934/MoE_Experiments/opencompass
opencv                        4.6.0
opencv-python-headless        4.9.0.80
optimum                       1.18.0.dev0
packaging                     23.1
pandas                        1.5.2
pandocfilters                 1.5.0
parso                         0.8.3
partd                         1.4.0
pathspec                      0.12.1
pathvalidate                  3.2.0
pathy                         0.10.1
peft                          0.9.0
pexpect                       4.8.0
pickleshare                   0.7.5
Pillow                        9.2.0
pip                           24.0
platformdirs                  3.5.1
plotly                        5.20.0
pluggy                        1.0.0
ply                           3.11
polygraphy                    0.47.1
pooch                         1.7.0
portalocker                   2.8.2
preshed                       3.0.8
prettytable                   3.7.0
proces                        0.1.7
prometheus-client             0.16.0
prompt-toolkit                3.0.38
promptsource                  0.2.3
protobuf                      3.20.3
psutil                        5.9.4
ptxcompiler                   0.7.0+27.g601c71a
ptyprocess                    0.7.0
pure-eval                     0.2.2
py-cpuinfo                    9.0.0
py7zr                         0.21.0
pyarrow                       15.0.2
pyarrow-hotfix                0.6
pyasn1                        0.5.0
pyasn1-modules                0.3.0
pybcj                         1.0.2
pybind11                      2.10.4
pycocotools                   2.0+nv0.7.3
pycodestyle                   2.11.1
pycparser                     2.21
pycryptodomex                 3.20.0
pydantic                      1.10.7
pydeck                        0.8.1b0
pyflakes                      3.2.0
Pygments                      2.15.1
PyGObject                     3.42.1
pylibcugraph                  23.4.0
pylibcugraphops               23.4.0
pylibraft                     23.4.0
pynvml                        11.4.1
pyparsing                     3.0.9
pypinyin                      0.51.0
pyppmd                        1.1.0
pyrsistent                    0.19.3
PySocks                       1.7.1
pytablewriter                 1.2.0
pytest                        7.3.1
pytest-rerunfailures          11.1.2
pytest-shard                  0.1.2
pytest-xdist                  3.3.1
python-dateutil               2.8.2
python-hostlist               1.23.0
python-Levenshtein            0.25.0
pytorch-quantization          2.1.2
pytz                          2023.3
PyYAML                        6.0
pyzmq                         25.0.2
pyzstd                        0.15.10
raft-dask                     23.4.0
rank-bm25                     0.2.2
rapidfuzz                     3.6.2
regex                         2023.5.5
requests                      2.31.0
requests-oauthlib             1.3.1
resampy                       0.4.2
responses                     0.18.0
rich                          13.7.1
rmm                           23.4.0
rouge                         1.0.1
rouge-chinese                 1.0.3
rouge-score                   0.1.2
rsa                           4.9
s3transfer                    0.6.1
sacrebleu                     2.4.1
safetensors                   0.4.2
scikit-learn                  1.2.1
scipy                         1.10.1
seaborn                       0.12.2
Send2Trash                    1.8.2
sentence-transformers         2.2.2
sentencepiece                 0.2.0
sentry-sdk                    1.44.0
setproctitle                  1.3.3
setuptools                    65.5.1
sgmllib3k                     1.0.0
six                           1.16.0
smart-open                    6.3.0
smmap                         5.0.1
sniffio                       1.3.1
snowballstemmer               2.2.0
sortedcontainers              2.4.0
soundfile                     0.12.1
soupsieve                     2.4.1
spacy                         3.5.3
spacy-legacy                  3.0.12
spacy-loggers                 1.0.4
Sphinx                        6.1.3
sphinx-click                  4.4.0
sphinx-glpi-theme             0.3
sphinxcontrib-applehelp       1.0.4
sphinxcontrib-devhelp         1.0.2
sphinxcontrib-htmlhelp        2.0.1
sphinxcontrib-jsmath          1.0.1
sphinxcontrib-qthelp          1.0.3
sphinxcontrib-serializinghtml 1.1.5
sqlitedict                    2.1.0
srsly                         2.4.6
ssh-import-id                 5.11
stack-data                    0.6.2
streamlit                     0.82.0
supervisor                    4.2.1
sympy                         1.12
tabledata                     1.3.3
tabulate                      0.9.0
tbb                           2021.9.0
tblib                         1.7.0
tcolorpy                      0.1.4
tenacity                      8.2.3
tensorboard                   2.9.0
tensorboard-data-server       0.6.1
tensorboard-plugin-wit        1.8.1
tensorrt                      8.6.1
termcolor                     2.3.0
terminado                     0.17.1
terminaltables                3.1.10
texttable                     1.7.0
thinc                         8.1.10
threadpoolctl                 3.1.0
thriftpy2                     0.4.16
tiktoken                      0.6.0
timeout-decorator             0.5.0
tinyBenchmarks                1.0.0
tinycss2                      1.2.1
tokenizers                    0.15.2
toml                          0.10.2
tomli                         1.2.3
toolz                         0.12.0
torch                         2.2.1
torch-tensorrt                1.4.0.dev0
torchaudio                    2.2.1
torchdata                     0.6.0
torchtext                     0.15.1
torchvision                   0.17.1
tornado                       6.3.1
tqdm                          4.64.1
tqdm-multiprocess             0.0.11
traitlets                     5.9.0
transformers                  4.40.0.dev0          /home/u2139934/MoE_Experiments/transformers
treelite                      3.2.0
treelite-runtime              3.2.0
triton                        2.2.0
TWCC-CLI                      0.6.1
typepy                        1.3.2
typer                         0.7.0
types-dataclasses             0.6.6
typing_extensions             4.10.0
tzlocal                       5.2
ucx-py                        0.31.0
uff                           0.6.9
urllib3                       1.26.15
validators                    0.24.0
wandb                         0.16.5
wasabi                        1.1.1
watchdog                      4.0.0
wcwidth                       0.2.6
webencodings                  0.5.1
Werkzeug                      2.3.4
wheel                         0.40.0
word2number                   1.1
xdoctest                      1.0.2
xgboost                       1.7.5
xxhash                        3.4.1
yapf                          0.40.2
yarl                          1.9.2
zict                          3.0.0
zipp                          3.15.0
zstandard                     0.22.0

```